<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulation Key Users - Test UI</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Cabin', sans-serif; background-color: #071520; color: #F6A316; padding: 20px;}
    h1 { font-size: 1.7em; }
    .form-section { background: #0D2D45; border-radius:12px; padding:18px; margin-bottom:18px;}
    label { font-weight: 600; margin-bottom: 6px; display: block;}
    select, input[type="file"], input[type="text"], textarea { width: 100%; margin-bottom: 10px; padding:8px; border-radius:5px; border:1px solid #F6A316; background:#071520; color: #F6A316;}
    button { background: #F6A316; color: #071520; font-weight: bold; border:none; padding:8px 13px; border-radius:5px; margin-top:8px; cursor:pointer;}
    .remove-btn { background:#F6A316; color:#071520; position:absolute; right:10px; top:10px; }
    .question-zone { margin-top:18px; border:1px solid #F6A316; padding:18px; background:#071520; border-radius:8px; position:relative;}
    .question-zone h4 { margin: 0 0 15px 0; color: #F6A316; font-size: 1.1em; }
    .question-zone .remove-btn { background:#F6A316; color:#071520; position:absolute; right:15px; top:15px; padding: 5px 10px; font-size: 0.8em; }
    .results { margin-top:22px; background:#0D2D45; color: #fff; border-radius:8px; padding:15px;}
    .image-preview {max-width:100%; margin-bottom:12px;}
  </style>
</head>
<body>
<h1>Simulation Key Users - Test UI</h1>
<div class="form-section">
  <label for="personaDropdown">S√©lectionnez le Key User (persona):</label>
  <select id="personaDropdown">
    <option value="P1_Sp√©cialiste_UI">Sp√©cialiste UI</option>
    <option value="P2_Sp√©cialiste_UX">Sp√©cialiste UX</option>
    <option value="P3_D√©veloppeur_junior_homme">D√©v junior homme</option>
    <option value="P4_D√©veloppeur_reconversion_expertise">D√©v junior/senior/confirm√© (reconversion, expertise)</option>
    <option value="P5_D√©veloppeur_senior_homme">D√©v senior homme</option>
    <option value="P6_D√©veloppeur_confirm√©_femme">D√©v confirm√© femme</option>
    <option value="P7_D√©veloppeur_junior_femme_reconversion">D√©v junior femme (reconversion, alternance)</option>
    <option value="P8_D√©veloppeur_junior_homme_BTS">D√©v junior homme (BTS sans alternance)</option>
  </select>
  <br>
  <label for="apiProvider">Fournisseur d'IA :</label>
  <select id="apiProvider" onchange="updateApiKeyPlaceholder()">
    <option value="mistral">Mistral AI</option>
    <option value="openai">OpenAI (GPT - Gratuit)</option>
    <option value="gemini">Google Gemini (Gratuit)</option>
    <option value="grok">Grok (xAI - Payant)</option>
  </select>
  <br>
  <label for="apiKey" id="apiKeyLabel">Cl√© API Mistral :</label>
  <input type="text" id="apiKey" placeholder="Ins√©rez votre cl√© API Mistral ici" />
  <br>
  
  <!-- Bouton pour ajouter la premi√®re question -->
  <div style="margin: 20px 0; padding: 15px; background: #0D2D45; border-radius: 8px; border: 1px solid #F6A316;">
    <button onclick="addQuestion()" style="background: #F6A316; color: #071520; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.1em;">
      ‚ûï Commencer ma premi√®re question
    </button>
    <p style="margin: 10px 0 0 0; color: #F6A316; font-size: 0.9em;">
      Cliquez ici pour cr√©er votre premi√®re question et uploader une image UI √† analyser
    </p>
  </div>
  
  <div id="questionsArea">
    <!-- Questions/r√©ponses dynamiques ici -->
  </div>
  <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; padding: 15px; background: #0D2D45; border-radius: 8px;">
    <button onclick="addQuestion()" style="background: #F6A316; color: #071520; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
      ‚ûï Ajouter une question
    </button>
    <button onclick="generateAllAIAnswers()" style="background: #F6A316; color: #071520; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
      ü§ñ G√©n√©rer toutes les r√©ponses IA
    </button>
    <button onclick="saveAllAnswers()" style="background: #0D2D45; color: #F6A316; border: 1px solid #F6A316; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
      üíæ Sauvegarder toutes les r√©ponses
    </button>
    <button onclick="exportResults()" style="background: #0D2D45; color: #F6A316; border: 1px solid #F6A316; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
      üìä Exporter Excel
    </button>
    <button onclick="viewSavedData()" style="background: #0D2D45; color: #F6A316; border: 1px solid #F6A316; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
      üìã Voir donn√©es sauvegard√©es
    </button>
  </div>
  
  <div class="results" id="resultsDisplay"></div>
</div>
<script>
// Fonction pour mettre √† jour le placeholder selon le fournisseur s√©lectionn√©
function updateApiKeyPlaceholder() {
  const provider = document.getElementById('apiProvider').value;
  const apiKeyInput = document.getElementById('apiKey');
  const apiKeyLabel = document.getElementById('apiKeyLabel');
  
  switch (provider) {
    case 'openai':
      apiKeyLabel.textContent = 'Cl√© API OpenAI :';
      apiKeyInput.placeholder = 'Ins√©rez votre cl√© API OpenAI (sk-...) ici';
      break;
    case 'gemini':
      apiKeyLabel.textContent = 'Cl√© API Google Gemini :';
      apiKeyInput.placeholder = 'Ins√©rez votre cl√© API Gemini ici';
      break;
    case 'grok':
      apiKeyLabel.textContent = 'Cl√© API Grok (xAI) :';
      apiKeyInput.placeholder = 'Ins√©rez votre cl√© API Grok (xai-...) ici';
      break;
    default: // mistral
      apiKeyLabel.textContent = 'Cl√© API Mistral :';
      apiKeyInput.placeholder = 'Ins√©rez votre cl√© API Mistral ici';
  }
}

const personas = {
  "P1_Sp√©cialiste_UI": {
    desc: "Sp√©cialiste UI, cherche plusieurs sites r√©f√©rences UI avant de r√©pondre. Sources : Dribbble, Behance, Awwwards, Mobbin.",
    instructions: "Analyse l'UI en te basant sur Dribbble, Behance, Awwwards, Mobbin et cite tes sources."
  },
  "P2_Sp√©cialiste_UX": {
    desc: "Sp√©cialiste UX, se r√©f√®re au Baymard Institute, compl√®te par d'autres r√©f√©rences UX. Sources : Baymard Institute, UX Collective, Awwwards.",
    instructions: "Analyse l'exp√©rience utilisateur selon le Baymard Institute et compl√®te par d'autres sites UX reconnus. Cite tes sources."
  },
  "P3_D√©veloppeur_junior_homme": {
    desc: "D√©veloppeur junior, homme, <2 ans XP, master/bts, sans alternance, b√©n√©vole.",
    instructions: "Donne ton ressenti de d√©veloppeur junior sur l'UI, sans expertise forte, en te basant sur ce que tu as appris en BTS/master. Reste synth√©tique."
  },
  "P4_D√©veloppeur_reconversion_expertise": {
    desc: "D√©v junior/senior/confirm√©, reconversion, conna√Æt r√®gles UX Baymard et UI, b√©n√©vole.",
    instructions: "Analyse l'UI en mobilisant tes connaissances des r√®gles Baymard et UI, selon ton profil mixte reconversion et niveaux d'exp√©rience. Cite tes r√©f√©rences."
  },
  "P5_D√©veloppeur_senior_homme": {
    desc: "D√©v. senior, homme, >10 ans XP, mentor b√©n√©volat.",
    instructions: "Donne ton avis bas√© sur ta longue exp√©rience, en comparant l'UI/UX √† des projets similaires pro. Cite des standards ou best practices utilis√©es en entreprise."
  },
  "P6_D√©veloppeur_confirm√©_femme": {
    desc: "D√©v. confirm√©, femme, 3-7 ans XP, b√©n√©vole pour progresser en UI/UX.",
    instructions: "Exprime ton ressenti sur la simplicit√© et l'apport UX de l'UI, en t'appuyant sur quelques r√®gles et sur ton exp√©rience pratique."
  },
  "P7_D√©veloppeur_junior_femme_reconversion": {
    desc: "D√©v. junior, femme, <2 ans XP, Master, alternance, reconversion, b√©n√©vole.",
    instructions: "R√©ponds sur l'accessibilit√© de l'UI et la prise en main facile, en te r√©f√©rant √† tes exp√©riences en alternance ou recommandations vues sur Behance."
  },
  "P8_D√©veloppeur_junior_homme_BTS": {
    desc: "D√©v. junior, homme, <2 ans XP, BTS sans alternance, b√©n√©vole.",
    instructions: "Donne ton sentiment sur l'UI en te focalisant sur la lisibilit√© et la simplicit√©, style BTS d√©butant, sans expertise approfondie mais curieux."
  }
};

let questions = [];
// Fonction supprim√©e car l'image principale n'existe plus

function showQuestionImagePreview(qId, event) {
  const imgPreview = document.getElementById(qId + '_preview');
  imgPreview.src = URL.createObjectURL(event.target.files[0]);
  imgPreview.style.display = 'block';
}

function addQuestion() {
  const questionsArea = document.getElementById('questionsArea');
  const qId = "q" + (questions.length + 1);
  const zone = document.createElement('div');
  zone.className = "question-zone";
  zone.id = qId;
  
  // D√©terminer si c'est la premi√®re question
  const isFirstQuestion = questions.length === 0;
  const questionNumber = questions.length + 1;
  
  zone.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h4 style="margin: 0; color: #F6A316;">
        ${isFirstQuestion ? 'üéØ Premi√®re Question' : `Question ${questionNumber}`}
      </h4>
      <button class="remove-btn" onclick="removeQuestion('${qId}')">Supprimer</button>
    </div>
    
    ${isFirstQuestion ? `
    <div style="background: #0D2D45; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 3px solid #F6A316;">
      <p style="margin: 0; color: #F6A316; font-size: 0.9em;">
        üí° Cette est votre premi√®re question. Uploadez une image UI et posez votre question pour commencer l'analyse.
      </p>
    </div>
    ` : ''}
    
    <label>${isFirstQuestion ? 'Image UI √† analyser :' : 'Image UI pour cette question (optionnel) :'}</label>
    <input type="file" id="${qId}_img" accept="image/*" onchange="showQuestionImagePreview('${qId}', event)" style="margin-bottom: 10px;"/>
    <img id="${qId}_preview" class="image-preview" style="display:none; max-width: 200px; margin-bottom: 15px;" />
    
    <label>Question :</label>
    <input type="text" placeholder="${isFirstQuestion ? 'Ex: Que penses-tu de cette interface ?' : 'Votre question'}" id="${qId}_q"/>
    
    <label>R√©ponse :</label>
    <textarea placeholder="R√©ponse manuelle ou g√©n√©r√©e par IA" id="${qId}_a" rows="4"></textarea>
    
    <div class="question-actions" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
      <button onclick="generateAIAnswerForQuestion('${qId}')" style="background: #F6A316; color: #071520; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
        ü§ñ G√©n√©rer IA
      </button>
      <button onclick="saveAnswerForQuestion('${qId}')" style="background: #0D2D45; color: #F6A316; border: 1px solid #F6A316; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
        üíæ Sauvegarder
      </button>
      <button onclick="clearAnswerForQuestion('${qId}')" style="background: #071520; color: #F6A316; border: 1px solid #F6A316; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
        üóëÔ∏è Effacer
      </button>
    </div>
    
    <div id="${qId}_status" class="question-status" style="margin-top: 10px; padding: 8px; border-radius: 5px; display: none;"></div>
  `;
  questionsArea.appendChild(zone);
  questions.push(qId);
  
  // Masquer le bouton "Ajouter ma premi√®re question" apr√®s la premi√®re utilisation
  if (isFirstQuestion) {
    const firstQuestionButton = document.querySelector('button[onclick="addQuestion()"]');
    if (firstQuestionButton) {
      firstQuestionButton.parentElement.style.display = 'none';
    }
  }
}

function removeQuestion(qId) {
  document.getElementById(qId).remove();
  questions = questions.filter(q => q !== qId);
  
  // Si toutes les questions sont supprim√©es, restaurer le bouton "Ajouter ma premi√®re question"
  if (questions.length === 0) {
    const firstQuestionButton = document.querySelector('button[onclick="addQuestion()"]');
    if (firstQuestionButton && firstQuestionButton.parentElement.style.display === 'none') {
      firstQuestionButton.parentElement.style.display = 'block';
    }
  }
}

function saveAnswers() {
  let results = [];
  const user = document.getElementById('personaDropdown').value;
  const dt = new Date();
  const dateStr = dt.toLocaleDateString('fr-FR') + ' ' + dt.getHours().toString().padStart(2, '0') + ':' + dt.getMinutes().toString().padStart(2, '0');
  
  questions.forEach(qId => {
    const question = document.getElementById(qId + "_q").value;
    const reponse = document.getElementById(qId + "_a").value;
    const questionImage = document.getElementById(qId + "_img").files[0];
    const questionImageName = questionImage ? questionImage.name : '';
    
    if (question && reponse) { // Ne sauvegarder que si question ET r√©ponse existent
      results.push({
        "Date": dateStr,
        "Persona": user,
        "Image_Question": questionImageName,
        "Question": question,
        "R√©ponse": reponse
      });
    }
  });
  
  if (results.length > 0) {
    localStorage.setItem("results", JSON.stringify(results));
    document.getElementById('resultsDisplay').innerText = `${results.length} r√©ponses enregistr√©es.`;
    console.log('R√©ponses sauvegard√©es:', results);
  } else {
    document.getElementById('resultsDisplay').innerText = "Aucune r√©ponse √† sauvegarder.";
  }
}

async function generateAIAnswers() {
  const apiKey = document.getElementById('apiKey').value.trim();
  const provider = document.getElementById('apiProvider').value;
  
  if (!apiKey) {
    const providerNames = {
      'mistral': 'Mistral',
      'openai': 'OpenAI',
      'gemini': 'Google Gemini',
      'grok': 'Grok'
    };
    const providerName = providerNames[provider] || 'API';
    alert(`Merci de saisir la cl√© API ${providerName}`);
    return;
  }
  const user = document.getElementById('personaDropdown').value;
  
  // Afficher un indicateur de chargement
  document.getElementById('resultsDisplay').innerText = "G√©n√©ration des r√©ponses en cours...";
  
  for (let qId of questions) {
    const questionText = document.getElementById(qId + "_q").value;
    if (!questionText) continue;
    
    const persona = personas[user];
    let prompt = `Persona : ${persona.desc}\nInstructions : ${persona.instructions}\nQuestion utilisateur : ${questionText}`;
    
    // Note: L'image principale a √©t√© supprim√©e, chaque question a sa propre image
    
    // Ajouter l'image sp√©cifique √† la question si elle existe
    const questionImage = document.getElementById(qId + "_img").files[0];
    if (questionImage) {
      prompt += `\n\nImage UI sp√©cifique √† cette question : Une interface utilisateur sp√©cifique a √©t√© fournie pour cette question particuli√®re.`;
    }
    
    try {
      const apiEndpoints = {
        'mistral': '/api/mistral',
        'openai': '/api/openai',
        'gemini': '/api/gemini',
        'grok': '/api/grok'
      };
      const apiEndpoint = apiEndpoints[provider] || '/api/mistral';
      
      const defaultModels = {
        'mistral': 'mistral-small-latest',
        'openai': 'gpt-3.5-turbo',
        'gemini': 'gemini-pro',
        'grok': 'grok-beta'
      };
      const model = defaultModels[provider] || 'mistral-small-latest';
      
      const response = await fetch(apiEndpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          apiKey: apiKey,
          prompt: prompt,
          model: model
        }),
      });
      const data = await response.json();
      console.log('R√©ponse re√ßue pour question', qId, ':', data);
      
      if (data.success) {
        document.getElementById(qId + "_a").value = data.response;
      } else {
        const errorMsg = data.error || "Erreur inconnue";
        console.error('Erreur API:', errorMsg, data.details);
        document.getElementById(qId + "_a").value = "Erreur: " + errorMsg;
      }
    } catch (e) {
      console.error('Erreur de connexion:', e);
      document.getElementById(qId + "_a").value = "Erreur de connexion √† l'API: " + e.message;
    }
  }
  document.getElementById('resultsDisplay').innerText = "R√©ponses g√©n√©r√©es via IA.";
}

async function exportResults() {
  try {
    let data = JSON.parse(localStorage.getItem("results") || "[]");
    console.log('Donn√©es √† exporter:', data);
    console.log('Nombre total de donn√©es:', data.length);
    
    if (data.length == 0) { 
      document.getElementById('resultsDisplay').innerText = "‚ùå Aucune donn√©e √† exporter. Sauvegardez d'abord vos r√©ponses.";
      return; 
    }
    
    document.getElementById('resultsDisplay').innerText = "‚è≥ Pr√©paration de l'export avec images...";
    
    // Cr√©er un nouveau workbook
    const wb = XLSX.utils.book_new();
    
    // Cr√©er un worksheet avec les donn√©es structur√©es
    const wsData = [];
    const images = [];
    let currentRow = 0;
    
    // Ajouter l'en-t√™te
    wsData.push(['Question', 'Date', 'Persona', 'Image', 'Contenu', '', '']);
    
    for (let i = 0; i < data.length; i++) {
      const item = data[i];
      console.log(`Traitement item ${i + 1}/${data.length}:`, item);
      
      // Ajouter les m√©tadonn√©es
      wsData.push([
        `Question ${i + 1}`,
        item.Date,
        item.Persona,
        item.Image_Question || 'Aucune',
        '',
        '',
        ''
      ]);
      
      // Ajouter l'image de question si elle existe
      if (item.Image_Question_Base64 && item.Image_Question_Base64.length > 0) {
        console.log(`Image trouv√©e pour question ${i + 1}:`, item.Image_Question);
        console.log(`Taille base64: ${item.Image_Question_Base64.length} caract√®res`);
        
        try {
          // Convertir le base64 en format compatible SheetJS
          const imageData = item.Image_Question_Base64.replace(/^data:image\/[a-z]+;base64,/, '');
          console.log(`Image nettoy√©e, nouvelle taille: ${imageData.length} caract√®res`);
          
          // Essayer diff√©rents formats d'image
          const imageObj = {
            name: item.Image_Question,
            data: imageData,
            position: { r: currentRow + 1, c: 6 }, // Colonne G
            opts: { 
              base64: true, 
              width: 200, 
              height: 150,
              type: 'image' // Sp√©cifier le type
            }
          };
          
          images.push(imageObj);
          console.log(`Image ajout√©e √† la liste des images √† exporter`);
        } catch (error) {
          console.error(`Erreur lors du traitement de l'image pour question ${i + 1}:`, error);
        }
      }
      
      // Ajouter la question
      wsData.push(['Question:', '', '', '', item.Question, '', '']);
      
      // Ajouter la r√©ponse
      wsData.push(['R√©ponse:', '', '', '', item.R√©ponse, '', '']);
      
      // Ajouter une ligne vide entre les questions
      if (i < data.length - 1) {
        wsData.push(['', '', '', '', '', '', '']);
      }
      
      currentRow += 4; // Question + m√©tadonn√©es + r√©ponse + ligne vide
    }
    
    // Cr√©er le worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    
    // Ajuster la largeur des colonnes
    ws['!cols'] = [
      { wch: 15 }, // A - Labels
      { wch: 50 }, // B - Contenu principal
      { wch: 20 }, // C - Date
      { wch: 25 }, // D - Persona
      { wch: 30 }, // E - Image principale
      { wch: 35 }, // F - Image principale (affichage)
      { wch: 35 }  // G - Image question (affichage)
    ];
    
    // Ajuster la hauteur des lignes pour les r√©ponses
    ws['!rows'] = [];
    for (let i = 0; i < wsData.length; i++) {
      if (wsData[i] && wsData[i][0] === 'R√©ponse:') {
        ws['!rows'][i] = { hpt: 120 }; // Hauteur pour les r√©ponses
      } else if (wsData[i] && wsData[i][0] && wsData[i][0].startsWith('Question ')) {
        ws['!rows'][i] = { hpt: 160 }; // Hauteur pour les lignes avec images
      } else {
        ws['!rows'][i] = { hpt: 20 }; // Hauteur normale
      }
    }
    
    // Ajouter les images au worksheet
    console.log(`Nombre total d'images √† ajouter: ${images.length}`);
    if (images.length > 0) {
      ws['!images'] = images;
      console.log('Images ajout√©es au worksheet:', images);
    } else {
      console.log('Aucune image √† ajouter au worksheet');
    }
    
    // Ajouter le worksheet au workbook
    XLSX.utils.book_append_sheet(wb, ws, "R√©ponses_IA");
    
    // G√©n√©rer le nom de fichier
    const dt = new Date();
    const fname = `GOT_AgentIA_${dt.getFullYear()}${(dt.getMonth() + 1).toString().padStart(2, '0')}${dt.getDate().toString().padStart(2, '0')}_${dt.getHours().toString().padStart(2, '0')}${dt.getMinutes().toString().padStart(2, '0')}.xlsx`;
    
    // Exporter le fichier
    XLSX.writeFile(wb, fname);
    
    document.getElementById('resultsDisplay').innerText = `‚úÖ Fichier export√©: ${fname} (${data.length} r√©ponses avec ${images.length} images int√©gr√©es)`;
    console.log('Export r√©ussi:', fname, 'avec', images.length, 'images');
    console.log('D√©tails des images export√©es:', images);
    
  } catch (error) {
    console.error('Erreur lors de l\'export:', error);
    document.getElementById('resultsDisplay').innerText = `‚ùå Erreur lors de l'export: ${error.message}`;
  }
}

function viewSavedData() {
  try {
    let data = JSON.parse(localStorage.getItem("results") || "[]");
    console.log('Donn√©es sauvegard√©es:', data);
    console.log('Nombre total de donn√©es sauvegard√©es:', data.length);
    
    if (data.length == 0) {
      document.getElementById('resultsDisplay').innerText = "üìã Aucune donn√©e sauvegard√©e.";
      return;
    }
    
    let displayText = `üìã ${data.length} r√©ponses sauvegard√©es:\n\n`;
    data.forEach((item, index) => {
      displayText += `${index + 1}. [${item.Date}] ${item.Persona}\n`;
      if (item.Image_Question) {
        const hasImage = item.Image_Question_Base64 && item.Image_Question_Base64.length > 0 ? '‚úÖ' : '‚ùå';
        displayText += `   üñºÔ∏è Image: ${item.Image_Question} ${hasImage}\n`;
        if (item.Image_Question_Base64) {
          displayText += `   üìè Taille base64: ${item.Image_Question_Base64.length} caract√®res\n`;
        }
      }
      displayText += `   Q: ${item.Question}\n`;
      displayText += `   R: ${item.R√©ponse.substring(0, 100)}${item.R√©ponse.length > 100 ? '...' : ''}\n\n`;
    });
    
    document.getElementById('resultsDisplay').innerText = displayText;
  } catch (error) {
    console.error('Erreur lors de l\'affichage:', error);
    document.getElementById('resultsDisplay').innerText = `‚ùå Erreur: ${error.message}`;
  }
}

// Nouvelles fonctions pour les actions par question
async function generateAIAnswerForQuestion(qId) {
  const apiKey = document.getElementById('apiKey').value.trim();
  const provider = document.getElementById('apiProvider').value;
  
  if (!apiKey) {
    const providerNames = {
      'mistral': 'Mistral',
      'openai': 'OpenAI',
      'gemini': 'Google Gemini',
      'grok': 'Grok'
    };
    const providerName = providerNames[provider] || 'API';
    showQuestionStatus(qId, `‚ùå Merci de saisir la cl√© API ${providerName}`, 'error');
    return;
  }
  
  const questionText = document.getElementById(qId + "_q").value;
  if (!questionText) {
    showQuestionStatus(qId, '‚ùå Veuillez saisir une question', 'error');
    return;
  }
  
  const user = document.getElementById('personaDropdown').value;
  showQuestionStatus(qId, '‚è≥ G√©n√©ration en cours...', 'loading');
  
  const persona = personas[user];
  let prompt = `Persona : ${persona.desc}\nInstructions : ${persona.instructions}\nQuestion utilisateur : ${questionText}`;
  
  // Ajouter l'image sp√©cifique √† la question si elle existe
  const questionImage = document.getElementById(qId + "_img").files[0];
  if (questionImage) {
    prompt += `\n\nImage UI sp√©cifique √† cette question : Une interface utilisateur sp√©cifique a √©t√© fournie pour cette question particuli√®re.`;
  }
  
  try {
    const apiEndpoints = {
      'mistral': '/api/mistral',
      'openai': '/api/openai',
      'gemini': '/api/gemini',
      'grok': '/api/grok'
    };
    const apiEndpoint = apiEndpoints[provider] || '/api/mistral';
    
    const defaultModels = {
      'mistral': 'mistral-small-latest',
      'openai': 'gpt-3.5-turbo',
      'gemini': 'gemini-pro',
      'grok': 'grok-beta'
    };
    const model = defaultModels[provider] || 'mistral-small-latest';
    
    const response = await fetch(apiEndpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        apiKey: apiKey,
        prompt: prompt,
        model: model
      }),
    });
    const data = await response.json();
    console.log('R√©ponse re√ßue pour question', qId, ':', data);
    
    if (data.success) {
      document.getElementById(qId + "_a").value = data.response;
      showQuestionStatus(qId, '‚úÖ R√©ponse g√©n√©r√©e avec succ√®s', 'success');
    } else {
      const errorMsg = data.error || "Erreur inconnue";
      console.error('Erreur API:', errorMsg, data.details);
      showQuestionStatus(qId, `‚ùå Erreur: ${errorMsg}`, 'error');
    }
  } catch (e) {
    console.error('Erreur de connexion:', e);
    showQuestionStatus(qId, `‚ùå Erreur de connexion: ${e.message}`, 'error');
  }
}

async function saveAnswerForQuestion(qId) {
  const question = document.getElementById(qId + "_q").value;
  const reponse = document.getElementById(qId + "_a").value;
  
  if (!question || !reponse) {
    showQuestionStatus(qId, '‚ùå Question et r√©ponse requises', 'error');
    return;
  }
  
  try {
    // R√©cup√©rer les donn√©es existantes
    let existingData = JSON.parse(localStorage.getItem("results") || "[]");
    
    const user = document.getElementById('personaDropdown').value;
    const dt = new Date();
    const dateStr = dt.toLocaleDateString('fr-FR') + ' ' + dt.getHours().toString().padStart(2, '0') + ':' + dt.getMinutes().toString().padStart(2, '0');
    
    // Note: L'image principale a √©t√© supprim√©e, chaque question a sa propre image
    
    // V√©rifier s'il y a une image pour cette question
    const questionImage = document.getElementById(qId + "_img").files[0];
    const questionImageName = questionImage ? questionImage.name : '';
    let questionImageBase64 = '';
    if (questionImage) {
      try {
        questionImageBase64 = await imageToBase64(questionImage);
      } catch (error) {
        console.error('Erreur conversion image question:', error);
      }
    }
    
    const newEntry = {
      "Date": dateStr,
      "Persona": user,
      "Image_Question": questionImageName,
      "Image_Question_Base64": questionImageBase64,
      "Question": question,
      "R√©ponse": reponse
    };
    
    existingData.push(newEntry);
    localStorage.setItem("results", JSON.stringify(existingData));
    
    showQuestionStatus(qId, '‚úÖ R√©ponse sauvegard√©e avec images', 'success');
    console.log('R√©ponse sauvegard√©e pour question', qId, ':', newEntry);
  } catch (error) {
    console.error('Erreur lors de la sauvegarde:', error);
    showQuestionStatus(qId, `‚ùå Erreur de sauvegarde: ${error.message}`, 'error');
  }
}

function clearAnswerForQuestion(qId) {
  document.getElementById(qId + "_q").value = '';
  document.getElementById(qId + "_a").value = '';
  document.getElementById(qId + "_img").value = '';
  document.getElementById(qId + "_preview").style.display = 'none';
  showQuestionStatus(qId, 'üóëÔ∏è Question effac√©e', 'info');
}

function showQuestionStatus(qId, message, type) {
  const statusDiv = document.getElementById(qId + "_status");
  statusDiv.style.display = 'block';
  statusDiv.innerText = message;
  
  // Appliquer le style selon le type
  statusDiv.className = 'question-status';
  switch(type) {
    case 'success':
      statusDiv.style.background = '#e8f5e8';
      statusDiv.style.color = '#2e7d32';
      statusDiv.style.border = '1px solid #4caf50';
      break;
    case 'error':
      statusDiv.style.background = '#ffebee';
      statusDiv.style.color = '#c62828';
      statusDiv.style.border = '1px solid #f44336';
      break;
    case 'loading':
      statusDiv.style.background = '#fff3e0';
      statusDiv.style.color = '#ef6c00';
      statusDiv.style.border = '1px solid #ff9800';
      break;
    case 'info':
      statusDiv.style.background = '#e3f2fd';
      statusDiv.style.color = '#1565c0';
      statusDiv.style.border = '1px solid #2196f3';
      break;
  }
  
  // Masquer le statut apr√®s 3 secondes pour les succ√®s et infos
  if (type === 'success' || type === 'info') {
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 3000);
  }
}

// Fonction pour convertir une image en base64
function imageToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = reader.result;
      console.log('Image convertie en base64, taille:', result.length);
      console.log('Format de l\'image:', result.substring(0, 50) + '...');
      resolve(result);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Fonction pour r√©cup√©rer les images sauvegard√©es
async function getSavedImages() {
  const savedImages = {};
  
  // R√©cup√©rer les images des questions
  for (let qId of questions) {
    const questionImageFile = document.getElementById(qId + "_img").files[0];
    if (questionImageFile) {
      try {
        const base64 = await imageToBase64(questionImageFile);
        savedImages[qId] = {
          name: questionImageFile.name,
          data: base64
        };
      } catch (error) {
        console.error('Erreur conversion image question', qId, ':', error);
      }
    }
  }
  
  return savedImages;
}

// Fonctions pour les actions globales
async function generateAllAIAnswers() {
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) {
    document.getElementById('resultsDisplay').innerText = '‚ùå Merci de saisir la cl√© API Mistral';
    return;
  }
  
  if (questions.length === 0) {
    document.getElementById('resultsDisplay').innerText = '‚ùå Aucune question √† traiter';
    return;
  }
  
  document.getElementById('resultsDisplay').innerText = '‚è≥ G√©n√©ration de toutes les r√©ponses en cours...';
  
  for (let qId of questions) {
    const questionText = document.getElementById(qId + "_q").value;
    if (questionText) {
      await generateAIAnswerForQuestion(qId);
      // Petite pause entre les requ√™tes
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }
  
  document.getElementById('resultsDisplay').innerText = '‚úÖ G√©n√©ration termin√©e pour toutes les questions';
}

function saveAllAnswers() {
  if (questions.length === 0) {
    document.getElementById('resultsDisplay').innerText = '‚ùå Aucune question √† sauvegarder';
    return;
  }
  
  let savedCount = 0;
  for (let qId of questions) {
    const question = document.getElementById(qId + "_q").value;
    const reponse = document.getElementById(qId + "_a").value;
    
    if (question && reponse) {
      saveAnswerForQuestion(qId);
      savedCount++;
    }
  }
  
  if (savedCount > 0) {
    document.getElementById('resultsDisplay').innerText = `‚úÖ ${savedCount} r√©ponses sauvegard√©es`;
  } else {
    document.getElementById('resultsDisplay').innerText = '‚ùå Aucune r√©ponse compl√®te √† sauvegarder';
  }
}
</script>
</body>
</html> 